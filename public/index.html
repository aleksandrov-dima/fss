<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">

    <script type="text/javascript" src="js/rutoken.js"></script>
    <script type="text/javascript" src="js/gostCrypto.dist.js"></script>

    <script>
        function loadScript(src) {
            let s = document.createElement('script');
            s.src = src;
            document.head.appendChild(s);
        }

        // request by promise
        function request(method, url) {
            return new Promise((resolve, reject) => {
                let xhr = new XMLHttpRequest();
                xhr.responseType = 'arraybuffer';
                xhr.open(method, url, true);
                xhr.onload = () => {
                    if (xhr.status >= 200 && xhr.status < 300) {
                        resolve(xhr.response);
                    } else {
                        reject({
                            status: xhr.status,
                            statusText: xhr.statusText
                        });
                    }
                };
                xhr.onerror = function () {
                    reject({
                        status: xhr.status,
                        statusText: xhr.statusText
                    });
                };
                xhr.send();
            });
        }

        function pad(n, width, z) {
            return n.length >= width ? n : new Array(width - n.length + 1).join(z) + n;
        }

        function buf2hex(buffer) {
            let view = new Uint8Array(buffer);
            let hex = [...view].map(v => this.pad(v.toString(16), 2, '0'));
            return hex.join(':');
        }

        function generateUKM() {
            let buf = new Uint8Array(8);
            gostCrypto.getRandomValues(buf);
            return buf2hex(buf);
        }

        /*
        Инцициализирует плагин Рутокен
        */
        function initPlugin() {
            return rutoken
                .ready.then(() => {
                    if (window.chrome || typeof InstallTrigger !== 'undefined')
                        return rutoken.isExtensionInstalled();
                    else
                        return Promise.resolve(true);
                })
                .then(result => {
                    if (result)
                        return rutoken.isPluginInstalled();
                    else
                        throw { message: 'Расширение для браузера "Адаптер Рутокен Плагин" не установлено.' };
                })
                .then(result => {
                    if (result)
                        return rutoken.loadPlugin();
                    else
                        throw { message: 'Программное обеспечение "Рутокен Плагин" не установлено.' };
                })
                .then(plugin => {
                    rutoken.plugin = plugin;
                    loadScript('js/rutokenErrorDescription.js');
                    return Promise.resolve(plugin);
                })
                .catch(reason => console.log(reason));
        }

        /*
        * @argument ukm - user key material
        * @argument certData - Der / PEM
        * returns hex
        */
        function genKEK(ctx) {
            ctx.publicKey = buf2hex(gostCrypto.asn1.Certificate.decode(ctx.certData).subjectPublicKeyInfo.subjectPublicKey).substr(6);

            return initPlugin()
                .then(plugin => {
                    return plugin.enumerateDevices().then(devices => {
                        return plugin.login(0, '12345678')
                            .then(_ => {
                                return plugin.enumerateCertificates(0, plugin.CERT_CATEGORY_UNSPEC)
                                    .then(certs => {
                                        let certId = certs[0];
                                        console.log('Идентификатор сертификата:', certId);
                                        console.log('Публичный ключ ФСС:', ctx.publicKey);
                                        return plugin.getCertificate(0, certId).then(cert => {
                                            console.log('Сертификат:', cert);
                                            return plugin.getKeyByCertificate(0, certId).then(key => plugin.derive(0, key, ctx.publicKey, {
                                                ukm: ctx.ukm
                                            }));
                                        })
                                    });
                            });
                    });
                })
                .catch(e => {
                    if (e.message) {
                        console.log('Ошибка:', rutoken.errorDescription[e.message]);
                    } else {
                        console.log('Ошибка:', e);
                    }
                });
        }

        function encrypt(ctx) {
            console.log(' --- Шифрование --- ');            
            return gostCrypto.subtle.generateKey({ name: 'GOST 28147' }, false, ['encrypt']).then(cek => {                
                return gostCrypto.subtle.encrypt('GOST 28147-ECB', cek, ctx.data).then(encData => {
                    ctx.encriptedData = gostCrypto.coding.Base64.encode(encData);
                    return gostCrypto.subtle.importKey('raw', gostCrypto.coding.Hex.decode(ctx.kek), 'GOST 28147', true, ['wrapKey'])
                        .then(kek => {
                            return gostCrypto.subtle.wrapKey('raw', cek, kek, { name: 'GOST 28147-KW', ukm: gostCrypto.coding.Hex.decode(ctx.ukm) })
                                .then(encryptedKey => {                                    
                                    ctx.encryptedKey = gostCrypto.coding.Base64.encode(encryptedKey);
                                    return Promise.resolve();
                                });
                        })
                });
            });
        }

        function process() {            
            return request('GET', 'FSS_TEST_CERT_2017.der').then(certData => {
                let ctx = {
                    ukm: generateUKM(),
                    certData: certData
                }                
                console.log('ukm:', gostCrypto.coding.Base64.encode(gostCrypto.coding.Hex.decode(ctx.ukm)));
                return genKEK(ctx)
                    .then(kek => {
                        ctx.kek = kek;
                        console.log('kek:', kek);                        
                        return request('GET', 'getLNData.xml').then(data => {
                            ctx.data = data;
                            return encrypt(ctx).then(_ => {
                                console.log('encrypted data:', ctx.encriptedData);
                                console.log('encrypted key:', ctx.encryptedKey);
                                console.log(ctx);
                            });
                        });
                    });
            });
        }
    </script>

</head>

<body onload="process();">

</body>

</html>